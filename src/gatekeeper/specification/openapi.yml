openapi: 3.0.0

info:
  version: 1.0.0
  title: Pishahang Gatekeeper API
  description: The definition of the Gatekeeper's public API

servers:
  - url: /api/v3

tags:
  - name: Authentication
    description: User management and authentication
  - name: VIMs
    description: VIM settings
  - name: Descriptors
    description: Descriptors that have been uploaded and can be edited or onboarded
  - name: Services
    description: Services (onboarded service descriptors), their function descriptors, and their instances
  - name: Plugins
    description: List MANO plugins and control their lifecycle states

paths:
  # Authentication =================================================================================

  /auth:
    post:
      tags:
        - Authentication
      summary: Create a new access token
      description:
        Given a username and a password, returns an access token and a refresh token or fails with
        error 401 if the credentials are invalid.
      operationId: gatekeeper.api.auth.createTokenFromCredentials
      requestBody:
        description: The username and password to create a new access token with
        content:
          application/json:
            schema:
              required:
                - username
                - password
              properties:
                username:
                  type: string
                  example: "pishahang"
                password:
                  type: string
                  example: "1234"

      responses:
        "200":
          description:
            The provided credentials are valid and a new access token and refresh token have been
            returned.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/AccessToken"
                  - $ref: "#/components/schemas/RefreshToken"
        "401":
          $ref: "#/components/responses/Error401"
        "500":
          $ref: "#/components/responses/Error500"
    put:
      tags:
        - Authentication
      summary: Refresh an access token
      description:
        Given a refresh token, returns a new access token or fails with error 401 if the given
        refresh token is invalid.
      operationId: gatekeeper.api.auth.refreshToken
      requestBody:
        description: The refresh token which was handed out by the `/auth` endpoint
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/RefreshToken"
      responses:
        "200":
          description: The provided refresh token is valid and a new access token has been returned.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AccessToken"
        "401":
          $ref: "#/components/responses/Error401"
        "500":
          $ref: "#/components/responses/Error500"

  # Users ==========================================================================================

  /users:
    get:
      tags:
        - Authentication
      summary: Get a list of registered users
      description: Returns a list of all registered users
      operationId: gatekeeper.api.users.getUsers
      responses:
        "200":
          description: The list of users was successfully returned.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Users"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "500":
          $ref: "#/components/responses/Error500"
      security:
        - bearerAuth: []
    post:
      tags:
        - Authentication
      summary: Add a user
      operationId: gatekeeper.api.users.addUser
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/User"
      responses:
        "200":
          description: The user is successfully added
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "500":
          $ref: "#/components/responses/Error500"
      security:
        - bearerAuth: []

  /users/{username}:
    get:
      tags:
        - Authentication
      summary: Retrive a single user
      description: Returns a user by given username
      operationId: gatekeeper.api.users.retrieveUsers
      parameters:
        - name: username
          in: path
          required: true
          description: user to be deleted by the username
          schema:
            type: string
      responses:
        "200":
          description: The list of users was successfully returned.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Users"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "500":
          $ref: "#/components/responses/Error500"
      security:
        - bearerAuth: []

    delete:
      tags:
        - Authentication
      summary: delete a user
      operationId: gatekeeper.api.users.deleteUser
      parameters:
        - name: username
          in: path
          required: true
          description: user to be deleted by the username
          schema:
            type: string

      responses:
        "200":
          description: The user is successfully deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Users"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "500":
          $ref: "#/components/responses/Error500"
      security:
        - bearerAuth: []
    put:
      tags:
        - Authentication
      summary: Update the user by admin
      description:
        Updates the user information by admin. If the `password` field is empty, the user's password
        won't be changed.
      operationId: gatekeeper.api.users.updateUsers
      parameters:
        - name: username
          in: path
          required: true
          description: user to be updated by the username
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/User"
      responses:
        "200":
          description: The user was successfully returned and updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Users"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "500":
          $ref: "#/components/responses/Error500"
      security:
        - bearerAuth: []
  /current-user:
    get:
      tags:
        - Authentication
      summary: Retrive the current user
      description: Returns the current user by the username
      operationId: gatekeeper.api.users.getCurrentUser
      responses:
        "200":
          description: The current users was successfully returned.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Users"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "500":
          $ref: "#/components/responses/Error500"
      security:
        - bearerAuth: []
    put:
      tags:
        - Authentication
      summary: Update the current user information.
      description:
        Updates the current user information. If the `password` field is empty, the user's password
        won't be changed.
      operationId: gatekeeper.api.users.updateCurrentUser
      requestBody:
        content:
          application/json:
            schema:
              allOf:
                - $ref: "#/components/schemas/User"
                - type: object
                  properties:
                    isAdmin:
                      readOnly: true
      responses:
        "200":
          description: The user was successfully returned and updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Users"
        "401":
          $ref: "#/components/responses/Error401"
        "403":
          $ref: "#/components/responses/Error403"
        "500":
          $ref: "#/components/responses/Error500"
      security:
        - bearerAuth: []

  # Descriptors ====================================================================================

  /descriptors:
    get:
      tags:
        - Descriptors
      summary: Get a list of descriptors
      description: Returns a list of all descriptors of a specified type
      operationId: gatekeeper.api.descriptors.getDescriptorsByType
      parameters:
        - name: type
          in: query
          required: true
          description: Specifies the descriptor type
          schema:
            $ref: "#/components/schemas/DescriptorType"
      responses:
        "200":
          description: The list of descriptors was successfully returned.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Descriptors"
        "400":
          $ref: "#/components/responses/Error400"
        "500":
          $ref: "#/components/responses/Error500"
    post:
      tags:
        - Descriptors
      summary: Upload a new descriptor
      description: >
        Adds a new descriptor to the database. Note: The combination of a descriptor's vendor, name,
        and version have to be unique.
      operationId: gatekeeper.api.descriptors.addDescriptor
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/Descriptor"
      responses:
        "201":
          description: The descriptor was successfully added to the database.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Descriptor"
        "400":
          $ref: "#/components/responses/Error400"
        "500":
          $ref: "#/components/responses/Error500"

  /descriptors/{id}:
    get:
      tags:
        - Descriptors
      summary: Get a descriptor by its ID
      operationId: gatekeeper.api.descriptors.getDescriptorById
      parameters:
        - name: id
          in: path
          required: true
          description: The ID of the descriptor to be retrieved
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: The descriptor was successfully returned.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Descriptor"
        "404":
          $ref: "#/components/responses/Error404"
        "500":
          $ref: "#/components/responses/Error500"
    put:
      tags:
        - Descriptors
      summary: Update a descriptor by its ID
      description: Updates the content of the descriptor specified by the given ID
      operationId: gatekeeper.api.descriptors.updateDescriptor
      parameters:
        - name: id
          in: path
          required: true
          description: The ID of the descriptor to be updated
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              required:
                - content
              properties:
                content:
                  $ref: "#/components/schemas/DescriptorContent"
      responses:
        "200":
          description: The descriptor was successfully updated.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Descriptor"
        "400":
          $ref: "#/components/responses/Error400"
        "404":
          $ref: "#/components/responses/Error404"
        "500":
          $ref: "#/components/responses/Error500"
    delete:
      tags:
        - Descriptors
      summary: Delete a descriptor by its ID
      description: Deletes the descriptor with the provided ID if it exists.
      operationId: gatekeeper.api.descriptors.deleteDescriptorById
      parameters:
        - name: id
          in: path
          required: true
          description: ID of the descriptor to be deleted
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: The descriptor was successfully deleted.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Descriptor"
        "404":
          $ref: "#/components/responses/Error404"
        "500":
          $ref: "#/components/responses/Error500"

  # Services =======================================================================================

  /services:
    get:
      tags:
        - Services
      summary: Get a list of available services
      description: Returns a list of services available for instantiation
      operationId: gatekeeper.api.services.getServices
      responses:
        "200":
          description: The list of services was successfully returned.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Services"
        "500":
          $ref: "#/components/responses/Error500"
    post:
      tags:
        - Services
      summary: Add a service by onboarding a service descriptor
      description: >
        Onboards a service descriptor by its ID, adding a new available service. Snapshots of the
        service descriptor and all referenced descriptors are stored, which will be used for
        instantiation. Later edits to the corresponding descriptors will not modify the snapshots.
      operationId: gatekeeper.api.services.addService
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - id
              properties:
                id:
                  type: string
                  format: uuid
      responses:
        "201":
          description: The service descriptor was successfully onboarded and can now be instantiated.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Service"
        "400":
          $ref: "#/components/responses/Error400"
        "500":
          $ref: "#/components/responses/Error500"

  /services/{id}:
    get:
      tags:
        - Services
      summary: Get a service by its ID
      operationId: gatekeeper.api.services.getServiceById
      parameters:
        - name: id
          in: path
          required: true
          description: The ID of the service to be retrieved
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Details on the service were successfully returned.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Service"
        "404":
          $ref: "#/components/responses/Error404"
        "500":
          $ref: "#/components/responses/Error500"
    delete:
      tags:
        - Services
      summary: Delete a service by its ID
      description: Deletes the service with the provided ID if it exists and it has no instances.
      operationId: gatekeeper.api.services.deleteServiceById
      parameters:
        - name: id
          in: path
          required: true
          description: ID of the service to be deleted
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: The service was successfully deleted.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Service"
        "404":
          $ref: "#/components/responses/Error404"
        "500":
          $ref: "#/components/responses/Error500"

  # Service instances ==============================================================================

  /services/{serviceId}/instances:
    get:
      tags:
        - Services
      summary: List the instances of a service
      operationId: gatekeeper.api.services.getServiceInstances
      parameters:
        - name: serviceId
          in: path
          required: true
          description: The service ID
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: A list of service instances was successfully returned.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceInstances"
        "404":
          $ref: "#/components/responses/Error404"
        "500":
          $ref: "#/components/responses/Error500"
    post:
      tags:
        - Services
      summary: Instantiate a service
      operationId: gatekeeper.api.services.instantiateService
      parameters:
        - name: serviceId
          in: path
          required: true
          description: The service ID
          schema:
            type: string
            format: uuid
      # requestBody:
      #   required: true
      #   content:
      #     application/json:
      #       schema:
      #         type: object
      #         required:
      #           - id
      #         properties:
      #           id:
      #             type: string
      #             format: uuid
      responses:
        "201":
          description: The service instance was added and returned.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ServiceInstance"
        "400":
          $ref: "#/components/responses/Error400"
        "500":
          $ref: "#/components/responses/Error500"

  # VIMs ===========================================================================================

  /vims:
    get:
      tags:
        - VIMs
      summary: Get a list of VIMs
      operationId: gatekeeper.api.vims.getAllVims
      responses:
        "200":
          description: The list of VIMs was successfully returned.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Vims"
        "400":
          $ref: "#/components/responses/Error400"
        "500":
          $ref: "#/components/responses/Error500"
    post:
      tags:
        - VIMs
      summary: Add a VIM
      operationId: gatekeeper.api.vims.addVim
      requestBody:
        content:
          application/json:
            schema:
              oneOf:
                - $ref: "#/components/schemas/AwsVim"
                - $ref: "#/components/schemas/OpenStackVim"
                - $ref: "#/components/schemas/KubernetesVim"
      responses:
        "200":
          description: The vim is successfully added.
        "404":
          $ref: "#/components/responses/Error404"
        "500":
          $ref: "#/components/responses/Error500"
  /vims/{id}:
    delete:
      tags:
        - VIMs
      summary: Delete a VIM by its ID
      description: Deletes the VIM with the provided ID if it exists.
      operationId: gatekeeper.api.vims.deleteVim
      parameters:
        - name: id
          in: path
          required: true
          description: ID of the VIM to be deleted
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: The VIM was successfully deleted.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Vims"
        "404":
          $ref: "#/components/responses/Error404"
        "500":
          $ref: "#/components/responses/Error500"

  # Plugins ========================================================================================

  /plugins:
    get:
      tags:
        - Plugins
      summary: Get the list of registered plugins
      operationId: gatekeeper.api.plugins.getPlugins
      responses:
        "200":
          description: The list of plugins was successfully returned.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Plugins"
        "500":
          $ref: "#/components/responses/Error500"

  /plugins/{id}:
    get:
      tags:
        - Plugins
      summary: Get information about a single plugin
      operationId: gatekeeper.api.plugins.getPluginById
      parameters:
        - name: id
          in: path
          required: true
          description: ID of the plugin to return information about
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Information about the plugin was successfully returned.
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Plugin"
        "404":
          $ref: "#/components/responses/Error404"
        "500":
          $ref: "#/components/responses/Error500"
    delete:
      tags:
        - Plugins
      summary: Shut down a plugin by its ID
      operationId: gatekeeper.api.plugins.shutdownPluginById
      parameters:
        - name: id
          in: path
          required: true
          description: ID of the plugin to be shut down
          schema:
            type: string
            format: uuid
      responses:
        "204":
          description: The shutdown request was successfully made.
        "404":
          $ref: "#/components/responses/Error404"
        "500":
          $ref: "#/components/responses/Error500"

  /plugins/{id}/lifecycle:
    put:
      tags:
        - Plugins
      summary: Manipulate the lifecycle state of a plugin
      operationId: gatekeeper.api.plugins.changePluginStateById
      parameters:
        - name: id
          in: path
          required: true
          description: ID of the plugin whose state should be changed
          schema:
            type: string
            format: uuid
      requestBody:
        content:
          application/json:
            schema:
              required:
                - targetState
              properties:
                targetState:
                  type: string
                  enum:
                    - pause
                    - start
      responses:
        "204":
          description: The lifecycle manipulation request was successfully made.
        "404":
          $ref: "#/components/responses/Error404"
        "500":
          $ref: "#/components/responses/Error500"

components:
  schemas:
    BaseEntity:
      required:
        - id
        - createdAt
        - updatedAt
      properties:
        id:
          description: A randomly generated UUID
          type: string
          format: uuid
          readOnly: true
        createdAt:
          type: string
          format: date-time
          readOnly: true
        updatedAt:
          type: string
          format: date-time
          readOnly: true

    DescriptorType:
      type: string
      enum: [service, openStack, kubernetes, aws]
    DescriptorContent:
      type: object
      example:
        descriptor_version: "1.0"
        vendor: "my.vendor"
        name: "example-descriptor"
        version: "1.0.0"
    Descriptor:
      allOf:
        - $ref: "#/components/schemas/BaseEntity"
        - type: object
          required:
            - type
            - content

          properties:
            type:
              $ref: "#/components/schemas/DescriptorType"
            content:
              $ref: "#/components/schemas/DescriptorContent"
            contentString:
              type: string
              description: Need some thoughts!!
    Descriptors:
      type: "array"
      items:
        $ref: "#/components/schemas/Descriptor"

    Service:
      allOf:
        - $ref: "#/components/schemas/BaseEntity"
        - type: object
          required:
            - descriptorSnapshots
            - rootDescriptorId
          properties:
            descriptorSnapshots:
              $ref: "#/components/schemas/Descriptors"
            rootDescriptorId:
              type: string
              format: uuid
            vendor:
              type: string
              example: "my.vendor"
            name:
              type: string
              example: "my-service"
            version:
              type: string
              example: "1.0"
    Services:
      type: "array"
      items:
        $ref: "#/components/schemas/Service"

    ServiceInstance:
      allOf:
        - $ref: "#/components/schemas/BaseEntity"
        - type: object
          required:
            - status
          properties:
            status:
              type: string
    ServiceInstances:
      type: "array"
      items:
        $ref: "#/components/schemas/ServiceInstance"

    BaseVim:
      allOf:
        - $ref: "#/components/schemas/BaseEntity"
        - type: object
          required:
            - vimName
            - country
            - vimCity
            - coreTotal
            - coreUsed
            - memoryTotal
            - memoryUsed
          properties:
            vimName:
              type: string
            country:
              type: string
            vimCity:
              type: string
            coreTotal:
              type: string
              readOnly: true
            coreUsed:
              type: string
              readOnly: true
            memoryUsed:
              type: string
              readOnly: true
            memoryTotal:
              type: string
              readOnly: true
    OpenStackVim:
      allOf:
        - $ref: "#/components/schemas/BaseVim"
        - type: object
          required:
            - vimAddress
            - tenantId
            - tenantExternalNetworkId
            - tenantExternalRouterId
            - username
            - password
            - type
          properties:
            type:
              type: string
              enum: ["openStack"]
            vimAddress:
              type: string
            tenantId:
              type: string
            tenantExternalNetworkId:
              type: string
            tenantExternalRouterId:
              type: string
            username:
              type: string
            password:
              type: string
    KubernetesVim:
      allOf:
        - $ref: "#/components/schemas/BaseVim"
        - type: object
          required:
            - vimAddress
            - serviceToken
            - ccc
            - type
          properties:
            type:
              type: string
              enum: ["kubernetes"]
            vimAddress:
              type: string
            serviceToken:
              type: string
            ccc:
              type: string
    AwsVim:
      allOf:
        - $ref: "#/components/schemas/BaseVim"
        - type: object
          required:
            - type
            - accessKey
            - secretKey
          properties:
            type:
              type: string
              enum: ["aws"]
            accessKey:
              type: string
            secretKey:
              type: string
    Vims:
      type: "array"
      items:
        $ref: "#/components/schemas/BaseVim"

    User:
      allOf:
        - $ref: "#/components/schemas/BaseEntity"
        - type: object
          required:
            - username
            - password
            - isAdmin
            - fullName
            - email
          properties:
            username:
              type: string
            password:
              type: string
              writeOnly: true
            isAdmin:
              type: boolean
            fullName:
              type: string
            email:
              type: string
              format: email
    Users:
      type: "array"
      items:
        $ref: "#/components/schemas/User"

    AccessToken:
      required:
        - accessToken
        - accessTokenExpiresIn
      properties:
        accessToken:
          type: string
        accessTokenExpiresIn:
          type: integer
          readOnly: true
    RefreshToken:
      required:
        - refreshToken
        - refreshTokenExpiresIn
      properties:
        refreshToken:
          type: string
        refreshTokenExpiresIn:
          type: integer
          readOnly: true

    Plugin:
      required:
        - id
        - name
        - version
        - description
        - state
        - registeredAt
        - lastHeartbeatAt
      properties:
        id:
          type: string
          format: uuid
        name:
          type: string
        version:
          type: string
        description:
          type: string
        state:
          type: string
          enum:
            - RUNNING
            - PAUSED
        registeredAt:
          type: string
          format: date-time
        lastHeartbeatAt:
          type: string
          format: date-time
    Plugins:
      type: "array"
      items:
        $ref: "#/components/schemas/Plugin"

    Message:
      required:
        - status
        - detail
      properties:
        status:
          type: integer
        detail:
          type: string

  responses:
    Error400:
      description: The request is invalid.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Message"
    Error401:
      description: The access token is missing or invalid.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Message"
    Error403:
      description: The action requires elevated privileges.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Message"
    Error404:
      description: The requested resource could not be found.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Message"
    Error500:
      description: An unexpected error occurred.
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/Message"

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      x-bearerInfoFunc: gatekeeper.api.auth.getTokenInfo
